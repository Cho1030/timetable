<!DOCTYPE html>
<html lang="ko">
<head>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="íƒ€ì„í…Œì´ë¸”">
<link rel="apple-touch-icon" href="icon-192.png">

<link rel="manifest" href="manifest.json">
<meta charset="UTF-8">
<title>íƒ€ì„í…Œì´ë¸”</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body{
  margin:0;
  padding:10px;
  font-family: Arial, sans-serif;
  background:#f9f9f9;
  transition: background 0.3s;
}

/* ì œëª© */
.title{
  display:flex;
  justify-content:center;
  align-items:baseline;
  gap:10px;
  margin-bottom:6px;
}
.title h2{
  margin:0;
  font-size:18px;
}
#nowTime{
  font-size:26px;
  font-weight:900;
  color:#d32f2f;
}

/* ì…ë ¥ ì˜ì—­ */
.controls{
  text-align:center;
  margin-bottom:6px;
}
.controls input,
.controls select{
  font-size:14px;
  padding:4px;
  width:70px;
  margin:2px;
  text-align:center;
}

/* ì „ì²´ ì˜ì—­ */
#container{
  position:relative;
  width:260px;
  height:260px;
  margin:0 auto;
}

#square{
  position:absolute;
  top:20px;
  left:20px;
  width:220px;
  height:220px;
  border:3px solid #3f51b5;
  display:grid;
  grid-template-columns:1fr 1fr;
  grid-template-rows:1fr 1fr;
  box-sizing:border-box;
}

/* ì‹œê°„ í‘œì‹œ ê³µí†µ */
.time{
  background:#e3f2fd;
  border-radius:10px;
  padding:3px 8px;
  margin:2px 0;
  font-size:13px;
  white-space:nowrap;
}

/* ğŸ”¥ ì •ë ¬ í•µì‹¬ (ì™„ì „ ê³ ì •) */
.top-left,
.bottom-left{
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  padding-left:4px;
  text-align:left;
}

.top-right,
.bottom-right{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  padding-right:4px;
  text-align:right;
}

.bottom-left,
.bottom-right{
  justify-content: flex-end;
}

/* ì…êµ¬ ë²„íŠ¼ */
.corner-btn{
  position:absolute;
  font-size:12px;
  padding:4px 8px;
  border-radius:6px;
  border:2px solid #3f51b5;
  background:#fff;
}
.btn-tl{top:0;left:0;transform:translate(-60%,-60%)}
.btn-tr{top:0;right:0;transform:translate(60%,-60%)}
.btn-bl{bottom:0;left:0;transform:translate(-60%,60%)}
.btn-br{bottom:0;right:0;transform:translate(60%,60%)}

/* ì§€ë‚˜ê°„ ì‹œê°„ */
.expired {
  color: #999;
  background: #eee;
  text-decoration: line-through;
}

/* í˜„ì¬ ì‹œê°„ê³¼ ê°€ì¥ ê°€ê¹Œìš´ ê³¼ê±° ì‹œê°„ */
.current-nearest {
  background: #ffeb3b;
  font-weight: bold;
}

/* ì…êµ¬ ë²„íŠ¼ìœ¼ë¡œ ê°•ì¡°ëœ ì‹œê°„ */
.entry-highlight {
  background: #c8e6c9;
  font-weight: bold;
}

/* ì•ŒëŒ ì œì–´ ì˜ì—­ */
.alarm-controls {
  margin-top: 50px;
  text-align: center;
}
.alarm-btn {
  font-size: 14px;
  padding: 8px 12px;
  margin: 5px;
  border-radius: 6px;
  border: 2px solid #3f51b5;
  background: #fff;
  cursor: pointer;
}
.alarm-btn.active {
  background: #3f51b5;
  color: white;
}
</style>
</head>

<body>

<div class="title">
  <h2>ğŸ“‹ íƒ€ì„í…Œì´ë¸”</h2>
  <span id="nowTime">--:--:--</span>
</div>

<div class="controls">
  <input id="startTime" placeholder="0800" maxlength="4">
  <select id="startCorner">
    <option value="0">ì¢Œìƒ</option>
    <option value="1">ìš°ìƒ</option>
    <option value="2">ìš°í•˜</option>
    <option value="3">ì¢Œí•˜</option>
  </select>
</div>

<div id="container">
 <div id="square">
  <div class="top-left" id="c0"></div>
  <div class="top-right" id="c1"></div>
  <div class="bottom-left" id="c3"></div>
  <div class="bottom-right" id="c2"></div>
</div>

<button class="corner-btn btn-tl" onclick="highlightEntry(0)">ë©”ì¸</button>
<button class="corner-btn btn-tr" onclick="highlightEntry(1)">ë©”ì¸</button>
<button class="corner-btn btn-br" onclick="highlightEntry(2)">ë©”ì¸</button>
<button class="corner-btn btn-bl" onclick="highlightEntry(3)">ë©”ì¸</button>
</div>

<div class="alarm-controls">
  <button id="alarmOn" class="alarm-btn" onclick="toggleAlarm(true)">ğŸ”” ì•ŒëŒ ì¼œê¸°</button>
  <button id="alarmOff" class="alarm-btn active" onclick="toggleAlarm(false)">ğŸ”• ì•ŒëŒ ë„ê¸°</button>
</div>

<script>
let activeEntries = new Set(); 

const order = [
  [0,1,2,3],
  [1,2,3,0],
  [2,3,0,1],
  [3,0,1,2]
];

const input = document.getElementById("startTime");
const select = document.getElementById("startCorner");

function draw(){
  const v = input.value;
  if(v.length!==4) return;

  const h=parseInt(v.slice(0,2));
  const m=parseInt(v.slice(2,4));
  if(h>23||m>59) return;

  document.querySelectorAll("#square > div").forEach(d=>d.innerHTML="");

  let t=new Date();
  t.setHours(h,m,0,0);

  let end=new Date();
  end.setHours(18,0,0,0);

  let i=0;
  while(t<=end){
    const d=document.createElement("div");
    d.className="time";
    d.innerText=t.toTimeString().slice(0,5);
    d.dataset.time = t.getTime();
    document.getElementById("c"+order[select.value][i%4]).appendChild(d);
    t=new Date(t.getTime()+40*60000);
    i++;
  }
}

input.addEventListener("input",draw);
select.addEventListener("change",draw);

// âœ… ì´ˆ ë‹¨ìœ„ê¹Œì§€ í‘œì‹œí•˜ë„ë¡ ìˆ˜ì •
function updateNow(){
  const n=new Date();
  document.getElementById("nowTime").innerText=
    String(n.getHours()).padStart(2,"0")+":"+
    String(n.getMinutes()).padStart(2,"0")+":"+
    String(n.getSeconds()).padStart(2,"0");
}
setInterval(updateNow,1000);
updateNow();

function updateTimeStatus(){
  const now = Date.now();
  const times = document.querySelectorAll(".time");

  let nearestPast = null;
  let nearestDiff = Infinity;

  times.forEach(el => {
    const t = parseInt(el.dataset.time);

    el.classList.remove("expired", "current-nearest");

    if(t < now){
      el.classList.add("expired");

      const diff = now - t;
      if(diff < nearestDiff){
        nearestDiff = diff;
        nearestPast = el;
      }
    }
  });

  if(nearestPast){
  nearestPast.classList.remove("expired"); 
  nearestPast.classList.add("current-nearest");
  }

  checkAlarm();
}

setInterval(updateTimeStatus, 1000);

function highlightEntry(corner){
  const protectedItem = document.querySelector(".current-nearest");
  if(activeEntries.has(corner)){
    document.querySelectorAll("#c"+corner+" .entry-highlight")
      .forEach(e => e.classList.remove("entry-highlight"));
    activeEntries.delete(corner);
    return;
  }
  activeEntries.add(corner);
  const now = Date.now();
  const list = [...document.querySelectorAll("#c"+corner+" .time")]
    .filter(el => el !== protectedItem)
    .map(el => ({
      el,
      diff: Math.abs(now - parseInt(el.dataset.time))
    }))
    .sort((a,b)=>a.diff-b.diff)
    .slice(0,3);

  list.forEach(o => {
    o.el.classList.add("entry-highlight");
  });
}

let isAlarmEnabled = false;
let lastAlarmTime = "";
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// âœ… ë¹„í”„ìŒì„ 3ë²ˆ ë°˜ë³µí•˜ë„ë¡ ìˆ˜ì •
function playBeep(count) {
  if (count <= 0) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.type = "sine";
  osc.frequency.setValueAtTime(880, audioCtx.currentTime);
  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.5); // 0.5ì´ˆ ì†Œë¦¬
  
  osc.onended = () => {
    setTimeout(() => playBeep(count - 1), 500); // 0.5ì´ˆ ê°„ê²©ìœ¼ë¡œ ë°˜ë³µ
  };
}

function triggerAlarmEffects() {
  if (navigator.vibrate) navigator.vibrate(5000);
  
  playBeep(3); // ë¹„í”„ìŒ 3ë²ˆ ì‹¤í–‰

  // âœ… ë°°ê²½ìƒ‰ 3ë¶„(180000ms) ìœ ì§€
  document.body.style.backgroundColor = "#ffcdd2";
  setTimeout(() => {
    // ì•ŒëŒì´ êº¼ì¡Œê±°ë‚˜ ìƒˆë¡œìš´ ì•ŒëŒì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ ì›ìƒë³µêµ¬
    if (document.body.style.backgroundColor === "rgb(255, 205, 210)") {
      document.body.style.backgroundColor = "#f9f9f9";
    }
  }, 180000);
}

function toggleAlarm(status) {
  isAlarmEnabled = status;
  document.getElementById('alarmOn').classList.toggle('active', status);
  document.getElementById('alarmOff').classList.toggle('active', !status);
  
  if(status) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    triggerAlarmEffects();
  } else {
    document.body.style.backgroundColor = "#f9f9f9"; // ì•ŒëŒ ëŒ ë•Œ ë°°ê²½ ì¦‰ì‹œ ë³µêµ¬
  }
}

function checkAlarm() {
  if (!isAlarmEnabled) return;

  const now = new Date();
  const currentTimeStr = now.getHours() + ":" + now.getMinutes();
  
  if (lastAlarmTime !== currentTimeStr) {
    triggerAlarmEffects();
    lastAlarmTime = currentTimeStr;
  }
}
</script>

</body>
</html>
